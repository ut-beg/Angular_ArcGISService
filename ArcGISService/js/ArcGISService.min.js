var arcGISServiceModule=angular.module("arcGISServiceModule",["localStorageServiceModule"]).factory("ArcGISService",["$q","$http","$window","LocalStorageService",function(n,t,i,r){var f,u;return this._userInfo=null,this._featureClassData={},this._serviceMetadata=null,f=r("continuum","applicationData"),f.get("userInfo")!=null&&(this._userInfo=f.get("userInfo")),u=this,u.baseRestApiUrl=null,u.editableRestApiUrl=null,u.setBaseRestApiUrl=function(n){n!=null&&n!=undefined&&n.length!=undefined&&n[n.length-1]!="/"&&(n+="/");u.baseRestApiUrl=n},u.setEditableRestApiUrl=function(n){n!=null&&n!=undefined&&n.length!=undefined&&n[n.length-1]!="/"&&(n+="/");u.editableRestApiUrl=n},this.setUserInfoDefaults=function(){this._userInfo={authToken:null,authTokenExpires:0,username:null,password:null,isAuthenticated:!1};f.set("userInfo",this._userInfo)},this._userInfo==null&&this.setUserInfoDefaults(),this.authenticateWithUserCredentials=function(t,i){var r=n.defer();return u._userInfo.username=t,u._userInfo.password=i,u.requestAuthToken().then(function(){u._userInfo.isAuthenticated=!0;r.resolve()}),r.promise},this.logout=function(){u.setUserInfoDefaults()},this.requestAuthToken=function(){var i=n.defer(),e,r;return u._userInfo.username!=undefined&&u._userInfo.username!=null&&u._userInfo.username!=""&&u._userInfo.password!=undefined&&u._userInfo.password!=null&&u._userInfo.password!=""?(e=arcGISServiceModule.tokenAuthenticationURL,r={username:u._userInfo.username,password:u._userInfo.password,f:"json"},r=arcGISServiceModule.composeQueryString(r),t({method:"POST",url:e,data:r,headers:{"Content-type":" application/x-www-form-urlencoded"}}).success(function(n){if(n.error!=undefined&&n.error.code==200&&n.error.details=="Invalid credentials")u.setUserInfoDefaults();else try{u._userInfo.authToken=n.token;u._userInfo.authTokenExpires=n.expires;u._userInfo.isAuthenticated=!0;f.set("userInfo",u._userInfo)}catch(t){}i.resolve()}).error(function(){i.reject()})):i.resolve(),i.promise},this.getCurrentServiceBaseAddress=function(){var n=u.baseRestApiUrl;return u._userInfo.isAuthenticated&&(n=arcGISServiceModule.editableRestApiUrl),n},this.getFeatureClasses=function(){var i=["MapServer"],t=n.defer();return u.getBasicParameters().then(function(n){u.doServiceRequest(i,n).then(function(n){t.resolve(n)})}),t.promise},this.getServiceMetadata=function(){var t=n.defer(),i;return u._serviceMetadata!=null?t.resolve(u._serviceMetadata):(i=["MapServer"],u.getBasicParameters().then(function(n){u.doServiceRequest(i,n).then(function(n){u._serviceMetadata=n;t.resolve(u._serviceMetadata)})})),t.promise},this.getLeafletOverlayProperties=function(){},this.getLegendData=function(){var t=n.defer(),i=["MapServer","legend"];return u.getBasicParameters().then(function(n){u.doServiceRequest(i,n).then(function(n){t.resolve(n)})}),t.promise},this.getFeatureClassDetails=function(t){var i=n.defer(),r=["MapServer",t];return u._featureClassData[t]!=null&&u._featureClassData!=undefined?i.resolve(u._featureClassData[t]):u.getBasicParameters().then(function(n){u.doServiceRequest(r,n).then(function(n){u._featureClassData[t]=n;i.resolve(n)})}),i.promise},this.getFeatureDetails=function(t,i){var r=n.defer();return u.getBasicParameters().then(function(n){var f="MapServer",e;n.token!=undefined&&n.token!=null&&n.token!=""&&(f="FeatureServer");e=[f,t,i];u.doServiceRequest(e,n).then(function(n){r.resolve(n)})}),r.promise},this.getRelatedItemData=function(t,i,r){var f=n.defer();return u.getBasicParameters().then(function(n){var e=["MapServer",i.toString(),"queryRelatedRecords"];n.objectIds=r.toString();n.relationshipId=t.id;n.returnGeometry="true";n.outFields="*";u.doServiceRequest(e,n).then(function(n){f.resolve(n)})}),f.promise},this.deleteFeature=function(t,i){var r=n.defer(),f=["FeatureServer","applyEdits"];return u.getBasicParameters().then(function(n){n.edits=[{id:t,deletes:[i]}];u.doServiceRequest(f,n).then(function(n){r.resolve(u.checkDeleteSuccess(t,n))})}),r.promise},this.checkDeleteSuccess=function(n,t){for(var r,u=!1,i=0;i<t.length;i++)if(t[i].id==n&&(r=t[i].deleteResults,r[0].success==!0)){u=r[0].success;break}return u},this.editFeature=function(t,i){var r=n.defer(),f;return u.notAllBlank(i)?(f=["FeatureServer","applyEdits"],u.getBasicParameters().then(function(n){u.prepareFeatureDataForSubmission(i,t).then(function(i){n.edits=[{id:t,updates:[i]}];u.doServiceRequest(f,n).then(function(n){r.resolve(u.checkUpdateSuccess(t,n))})})})):r.resolve(!1),r.promise},this.insertFeature=function(t,i){var r=n.defer(),f;return u.notAllBlank(i)?(f=["FeatureServer","applyEdits"],u.getBasicParameters().then(function(n){u.prepareFeatureDataForSubmission(i,t,!0).then(function(i){n.edits=[{id:t,adds:[i]}];u.doServiceRequest(f,n).then(function(n){r.resolve(u.checkInsertSuccess(t,n))})})})):r.resolve(null),r.promise},this.checkInsertSuccess=function(n,t){for(var r,u=null,i=0;i<t.length;i++)if(t[i].id==n&&(r=t[i].addResults,r[0].success==!0)){u=r[0].objectId;break}return u},this.checkUpdateSuccess=function(n,t){for(var u,r,f=!0,i=0;i<t.length;i++)if(t[i].id==n){for(u=t[i].updateResults,r=0;r<u.length;r++)if(u[r].success==!1){f=!1;break}break}return f},this.notAllBlank=function(n){for(var r=!1,i=Object.keys(n),t=0;t<i.length;t++)if(n[i[t]]!=undefined&&n[i[t]]!=null&&n[i[t]]!=""){r=!0;break}return r},this.prepareFeatureDataForSubmission=function(t,i){var f=n.defer(),r={};return u.getFeatureClassDetails(i).then(function(n){var s=u.getGeometryField(n),c=u.getPKField(n),e,h,o,i;for(s!=null&&(e=t[s.name],e!=undefined&&e!=null&&(h=Terraformer.ArcGIS.convert(e,{idAttribute:"OBJECTID"}),r.geometry=h)),r.attributes={},o=0;o<n.fields.length;o++)i=n.fields[o],i.type!="esriFieldTypeGeometry"&&(r.attributes[i.name]=u.prepareFeatureDataValueForSubmission(t[i.name],i));f.resolve(r)}),f.promise},this.prepareFeatureDataValueForSubmission=function(n,t){var i=null;if(t.type=="esriFieldTypeDate"&&typeof n=="object")try{i=n.getTime()}catch(r){i=n}else n!=undefined&&(i=n);return i},this.queryFeatureClass=function(t,i,r,f){var e=n.defer(),o=["MapServer",t,"query"],s=arcGISServiceModule.composeRouteString(o);return u.getBasicParameters().then(function(n){var t,s,h,c;(i==undefined||i==null||i=="")&&(i="1=1");t=null;s=null;r!=undefined&&r!=null&&(h=Terraformer.ArcGIS.convert(r,{idAttribute:"OBJECTID"}),t=h.geometry,c=JSON.stringify(t),r.geometry.type=="Polygon"?s="esriGeometryPolygon":r.geometry.type=="Point"&&(s="esriGeometryPoint"));n.where=i;n.outFields="*";t!=null&&(n.geometry=t,n.geometryType=s,delete n.geometry.spatialReference);f!=undefined&&f!=null&&(n.orderByFields=f);u.doServiceRequest(o,n).then(function(n){e.resolve(n)})}),e.promise},this.queryForAutoComplete=function(t,i,r){var f=n.defer(),e=["MapServer",t,"query"],o=arcGISServiceModule.composeRouteString(e);return u.getBasicParameters().then(function(n){var t=i+" LIKE '"+r+"%'";n.where=t;n.outFields=i;n.returnDistinctValues=!0;n.returnGeometry=!1;u.doServiceRequest(e,n).then(function(n){f.resolve(n)})}),f.promise},this.getPKField=function(n){for(var i=null,t=0;t<n.fields.length;t++)if(n.fields[t].type=="esriFieldTypeOID"){i=n.fields[t];break}return i},this.extractFeatureDataFromFeatureResponse=function(n,t,i){var r=n.feature,u=null;return r!=undefined&&r!=null&&(u=r.attributes,u.SHAPE=arcGISServiceModule.convertToGeoJSON(r.geometry,t,i),arcGISServiceModule.rectifyXCoords(u.SHAPE)),u},this.extractFeatureDataFromQueryResponse=function(n){var f=angular.fromJson(n),t=f,r=null,i,u;if(t!=null){for(r=[],i=0;i<t.features.length;i++)u=t.features[i].attributes,t.features[i].geometry!=undefined&&(u.SHAPE=arcGISServiceModule.convertToGeoJSON(t.features[i].geometry,t.geometryType,t.spatialReference),arcGISServiceModule.rectifyXCoords(u.SHAPE)),r.push(u);r.push()}return r},this.getTotalFeatureCount=function(t,i,r){var f=n.defer();return u.getBasicParameters().then(function(n){var h=["MapServer",t,"query"],e,o,s;(i==undefined||i==null||i=="")&&(i="1=1");e=null;o=null;r!=undefined&&r!=null&&(s=Terraformer.ArcGIS.convert(r,{idAttribute:"OBJECTID"}),e=s.geometry,r.geometry.type=="Polygon"&&(o="esriGeometryPolygon"));n.where=i;n.outFields="*";n.returnCountOnly=!0;u.doServiceRequest(h,n).then(function(n){f.resolve(n)})}),f.promise},this.getBasicParameters=function(){var t=n.defer(),i={f:"json"};return u.getAuthToken().then(function(n){n!=null&&(i.token=n);t.resolve(i)}),t.promise},this.getAuthToken=function(){var t=n.defer();return u._userInfo.authToken==null||u.authTokenIsExpired()?u.requestAuthToken().then(function(){t.resolve(u._userInfo.authToken)}):t.resolve(u._userInfo.authToken),t.promise},this.authTokenIsExpired=function(){var n=!1,t=(new Date).getTime();return u._userInfo.authToken!=null&&u._userInfo.authTokenExpires<t&&(n=!0),n},this.doServiceRequest=function(i,r){var f=n.defer(),e=arcGISServiceModule.composeRouteString(i),o=u.getCurrentServiceBaseAddress(),s=o+e,h=arcGISServiceModule.composeQueryString(r);return t({method:"POST",url:s,data:h,headers:{"Content-type":"application/x-www-form-urlencoded"}}).success(function(n){f.resolve(n)}).error(function(){f.reject()}),f.promise},this.getUserInfo=function(){return u._userInfo},this.setUserInfo=function(n){u._userInfo=n},this.loginUser=function(){return this.getAuthToken()},this.getGeometryField=function(n){for(var i,r=null,t=0;t<n.fields.length;t++)if(i=n.fields[t],i.type=="esriFieldTypeGeometry"){r=i;break}return r},this.getOverrideData=function(i){var r=n.defer(),u="http://coastal.beg.utexas.edu/continuum2/JSON/OverrideData/override_"+i+".json";return t({method:"GET",url:u}).success(function(n){n.getField=function(t){var r=null,i;if(n.fields!=undefined&&n.fields!=null)for(i=0;i<n.fields.length;i++)if(n.fields[i].name==t){r=n.fields[i];break}return r};r.resolve(n)}).error(function(){console.log(u);r.reject()}),r.promise},this.getPreviewImageUrl=function(t,i,r){for(var f,o=n.defer(),h=i.keyField,s=null,e=0;i.relatedRecordData.fields.length;e++)if(i.relatedRecordData.fields[e].name==h){s=i.relatedRecordData.fields[e];break}return f="",r!=null&&(f="RequestAsset.aspx?",f+="objectId="+r.attributes[s.name],f+="&",f+="layerId="+i.id,f+="&",f+="field="+t.name,f+="&",u.getAuthToken().then(function(n){n!=null&&(f+="&token="+n);f+="&serviceAddr="+encodeURIComponent(u.getCurrentServiceBaseAddress());var t={thumbnailUrl:f+"&mode=3",headerUrl:f+"&mode=2",fullUrl:f+"&mode=0"};o.resolve(t)})),o.promise},this}]);arcGISServiceModule.composeQueryString=function(n){var i="",r,t,u;for(r in n)t=n[r],t!=undefined&&t!=null&&(i!=""&&(i+="&"),(typeof t=="object"||typeof t=="array")&&(u=angular.toJson(t),t=u),i+=r+"="+encodeURIComponent(t));return i};arcGISServiceModule.composeRouteString=function(n){var i="",t;if(n!=undefined&&n!=null)for(t=0;t<n.length;t++)i+=n[t],t+1<n.length&&(i+="/");return i};arcGISServiceModule.composeFullURL=function(n,t){var i=arcGISServiceModule.composeQueryString(t),r=arcGISServiceModule.composeRouteString(n);return i!=""&&(i="?"+i),r!=""&&arcGISServiceModule.baseRestApiUrl[arcGISServiceModule.baseRestApiUrl.length-1]!="/"&&(r="/"+r),arcGISServiceModule.baseRestApiUrl+r+i};arcGISServiceModule.convertToGeoJSON=function(n,t,i){var r=null;return n!=null&&n!=undefined&&(r=Terraformer.ArcGIS.parse(n,i)),r};arcGISServiceModule.unrectifyXCoords=function(n){n.type=="Point"?arcGISServiceModule.unrectifyXCoordsPoint(n):n.type=="Polygon"&&arcGISServiceModule.unrectifyXCoordsPolygon(n)};arcGISServiceModule.unrectifyXCoordsPoint=function(n){n.type=="Point"&&n.coordinates[0]<0&&(n.coordinates[0]=n.coordinates[0]+360)};arcGISServiceModule.unrectifyXCoordsPolygon=function(n){for(var i,r=n.coordinates,t=0;t<r.length;t++)for(i=0;i<r[t].length;i++)r[t][i][0]<0&&(r[t][i][0]=r[t][i][0]+360)};arcGISServiceModule.rectifyXCoords=function(n){n.type=="Point"&&arcGISServiceModule.rectifyXCoordsPoint(n)};arcGISServiceModule.rectifyXCoordsPoint=function(n){n.type=="Point"&&n.coordinates[0]>180&&(n.coordinates[0]=n.coordinates[0]-360)};